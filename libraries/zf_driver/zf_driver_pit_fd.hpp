#ifndef __ZF_DRIVER_PIT_FD_HPP__
#define __ZF_DRIVER_PIT_FD_HPP__

#include <pthread.h>
#include <iostream>
#include <functional>
#include <sys/timerfd.h>
#include <unistd.h>
#include <inttypes.h>
#include <thread>
#include <chrono>

#include "zf_common_typedef.hpp"

class timer_fd 
{
public:
//-------------------------------------------------------------------------------------------------------------------
// 函数简介 构造函数
// 参数说明 interval 定时触发间隔，单位毫秒
// 参数说明 func     定时触发的回调函数
// 返回参数 无
// 使用示例 timer_fd timer(10, callback_func);
// 备注信息 初始化定时器参数，默认未启动状态
//-------------------------------------------------------------------------------------------------------------------
    timer_fd(int interval, const std::function<void()>& func);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 析构函数
// 参数说明 无
// 返回参数 无
// 使用示例 自动调用，无需手动调用
// 备注信息 自动停止定时器并回收线程资源，防止内存泄漏
//-------------------------------------------------------------------------------------------------------------------
    ~timer_fd();

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 启动定时器
// 参数说明 无
// 返回参数 无
// 使用示例 timer.start();
// 备注信息 定时器已运行时重复调用无效果，创建线程执行定时任务
//-------------------------------------------------------------------------------------------------------------------
    void start();

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 停止定时器
// 参数说明 无
// 返回参数 无
// 使用示例 timer.stop();
// 备注信息 定时器未运行时调用无效果，阻塞等待线程退出并释放资源
//-------------------------------------------------------------------------------------------------------------------
    void stop();

private:
    int interval;
    std::function<void()> func;
    std::thread timerThread;
    bool running;

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 初始化内核timerfd定时器句柄
// 参数说明 无
// 返回参数 int 成功返回定时器文件句柄 失败返回-1
// 使用示例 内部调用，无需外部调用
// 备注信息 基于CLOCK_MONOTONIC系统时钟，定时时间不受系统时间修改影响
//-------------------------------------------------------------------------------------------------------------------
    int init_timer_fd();

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 定时器线程主循环函数
// 参数说明 无
// 返回参数 无
// 使用示例 内部调用，无需外部调用
// 备注信息 设置线程为FIFO高优先级调度，保证定时精度，支持处理定时器溢出补触发
//-------------------------------------------------------------------------------------------------------------------
    void timer_loop();
};

#endif
#ifndef __zf_driver_pit_HPP__
#define __zf_driver_pit_HPP__

#include "zf_common_typedef.hpp"

#define PIT_MIN_PERIOD_MS        1
#define PIT_MAX_PERIOD_MS     1000

typedef void (*pit_callback_fun)(void);

//-------------------------------------------------------------------------------------------------------------------
// 类名         zf_driver_pit
// 说明         龙芯LS2K0300单核专用 强实时周期定时器类，timerfd内核高精度定时器实现
//-------------------------------------------------------------------------------------------------------------------
class zf_driver_pit
{
private:
    volatile sig_atomic_t pit_exit_flag;
    int pit_timer_fd;
    int pit_epoll_fd;
    pthread_t pit_thread_id;
    uint32_t pit_period_ms;
    pit_callback_fun pit_user_callback;

//-------------------------------------------------------------------------------------------------------------------
// 函数简介  PIT定时器核心线程处理函数
// 参数说明  arg 类对象指针，用于访问成员变量
// 返回参数  void* 线程返回值，固定返回NULL
// 使用示例  内部调用，无需外部调用
// 备注信息  阻塞监听epoll定时器事件，触发后执行用户注册的回调函数
//-------------------------------------------------------------------------------------------------------------------
    static void *pit_timer_thread(void *arg);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介  设置线程为SCHED_FIFO最高优先级实时调度策略
// 参数说明  无
// 返回参数  int 成功返回0 失败返回-1
// 使用示例  内部调用，无需外部调用
// 备注信息  龙芯单核独占CPU无抢占，替代x86的cli/sti指令，强实时核心保障
//-------------------------------------------------------------------------------------------------------------------
    int set_realtime_priority(void);

public:

//-------------------------------------------------------------------------------------------------------------------
// 函数简介  类的无参构造函数
// 参数说明  无
// 返回参数  无
// 使用示例  zf_driver_pit pit_timer;
// 备注信息  初始化所有私有成员变量为默认安全值，防止野指针与脏数据
//-------------------------------------------------------------------------------------------------------------------
    zf_driver_pit(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介  类的析构函数
// 参数说明  无
// 返回参数  无
// 使用示例  对象生命周期结束自动调用，无需手动调用
// 备注信息  自动释放定时器所有资源，防止内存泄漏与句柄残留
//-------------------------------------------------------------------------------------------------------------------
    ~zf_driver_pit(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介  PIT定时器初始化，配置周期并注册回调函数
// 参数说明  period_ms 定时器周期，单位ms
// 参数说明  callback 定时器中断回调函数指针，不能为空
// 返回参数  int 成功返回0 失败返回-1
// 使用示例  pit_timer.pit_init(10, pit_callback);
// 备注信息  一键完成所有初始化流程，龙芯平台即开即用，无需额外配置
//-------------------------------------------------------------------------------------------------------------------
    int init_ms(uint32_t period_ms, pit_callback_fun callback);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介  停止PIT定时器并释放所有资源
// 参数说明  无
// 返回参数  void 无返回值
// 使用示例  pit_timer.pit_stop();
// 备注信息  优雅退出定时器线程，关闭句柄，线程安全可重复调用
//-------------------------------------------------------------------------------------------------------------------
    void stop(void);
};

#endif
#include "zf_driver_pit_fd.hpp"

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 构造函数
// 参数说明 interval 定时触发间隔，单位毫秒
// 参数说明 func     定时触发的回调函数
// 返回参数 无
// 使用示例 timer_fd timer(10, callback_func);
// 备注信息 初始化定时器参数，默认未启动状态
//-------------------------------------------------------------------------------------------------------------------
timer_fd::timer_fd(int interval, const std::function<void()>& func)
    : interval(interval), func(func), running(false)
{
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 析构函数
// 参数说明 无
// 返回参数 无
// 使用示例 自动调用，无需手动调用
// 备注信息 自动停止定时器并回收线程资源，防止内存泄漏
//-------------------------------------------------------------------------------------------------------------------
timer_fd::~timer_fd()
{
    stop();
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 启动定时器
// 参数说明 无
// 返回参数 无
// 使用示例 timer.start();
// 备注信息 定时器已运行时重复调用无效果，创建线程执行定时任务
//-------------------------------------------------------------------------------------------------------------------
void timer_fd::start() 
{
    if (running) return;
    running = true;
    timerThread = std::thread(&timer_fd::timer_loop, this);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 停止定时器
// 参数说明 无
// 返回参数 无
// 使用示例 timer.stop();
// 备注信息 定时器未运行时调用无效果，阻塞等待线程退出并释放资源
//-------------------------------------------------------------------------------------------------------------------
void timer_fd::stop()
{
    if (!running) return;
    running = false;
    if (timerThread.joinable()) {
        timerThread.join();
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 初始化内核timerfd定时器句柄
// 参数说明 无
// 返回参数 int 成功返回定时器文件句柄 失败返回-1
// 使用示例 内部调用，无需外部调用
// 备注信息 基于CLOCK_MONOTONIC系统时钟，定时时间不受系统时间修改影响
//-------------------------------------------------------------------------------------------------------------------
int timer_fd::init_timer_fd() 
{
    int fd = timerfd_create(CLOCK_MONOTONIC, 0);
    if (fd == -1) {
        perror("timerfd_create");
        return -1;
    }

    struct itimerspec its;
    its.it_value.tv_sec = 0;
    its.it_value.tv_nsec = interval * 1000000;  // 毫秒转纳秒
    its.it_interval.tv_sec = 0;
    its.it_interval.tv_nsec = interval * 1000000;

    if (timerfd_settime(fd, 0, &its, NULL) == -1) {
        perror("timerfd_settime");
        close(fd);
        return -1;
    }

    return fd;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介 定时器线程主循环函数
// 参数说明 无
// 返回参数 无
// 使用示例 内部调用，无需外部调用
// 备注信息 设置线程为FIFO高优先级调度，保证定时精度，支持处理定时器溢出补触发
//-------------------------------------------------------------------------------------------------------------------
void timer_fd::timer_loop()
{
    int fd = init_timer_fd();
    if (fd == -1) return;

    // 设置线程为FIFO调度策略 + 高优先级(10)，保证定时器精准触发
    struct sched_param param;
    param.sched_priority = 10;
    pthread_setschedparam(pthread_self(), SCHED_FIFO, &param);

    uint64_t expirations;
    while (running) 
    {
        if (read(fd, &expirations, sizeof(expirations)) != sizeof(expirations)) 
        {
            perror("read timerfd");
            break;
        }

        // 处理定时器溢出：如果阻塞期间错过多次触发，一次性补全调用
        for (uint64_t i = 0; i < expirations; ++i)
        {
            func();
        }
    }
    close(fd);
}